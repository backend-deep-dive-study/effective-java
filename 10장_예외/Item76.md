# 가능한 한 실패 원자적으로 만들라

### 실패 원자적

- 호출된 메서드가 실패하더라도 해당 객체는 메서드 **호출 전 상태를 유지하는 특성**

### 메서드를 실패 원자적으로 만드는 방법

- 불변 객체로 설계
    - 불변 객체의 상태는 생성 시점에 고정되어 절대 변하지 않음
    - 메서드 실패 시 새로운 객체가 만들어지지 않을 수 있지만 기존 객체가 불안정한 상태에 빠지는 일은 없음

### 가변 객체의 메서드를 실패 원자적으로 만드는 방법

1. 매개변수 유효성 검사
    - 객체 내부 상태를 변경하기 전에 잠재적 예외의 가능성 대부분을 걸러낼 수 있음
    
    ```java
    public Object pop() {
    	if (size == 0)
    		throw new EmptyStackException();
    	Object result = elements[--size];
    	elements[size] = null; // 다 쓴 참조 해제
    	return result;
    }
    ```
    
    - if문에서 size 값이 0이면 예외 → 이 부분이 없어도 스택이 비었으면 예외 발생
        - if문이 없을 경우 size 값이 음수가 되어 다음 호출도 실패 (ArrayindexOutOfBoundsException 발생)
2. 실패할 가능성이 있는 모든 코드를 객체의 상태를 바꾸는 코드보다 앞에 배치
    - 계산을 수행해보기 전에 인수의 유효성 검사를 해볼 수 없을 때 사용하는 기법
    - ex) TreeMap: 원소들을 어떤 기준으로 정렬
        - TreeMap에 원소를 추가하려면 그 원소는 TreeMap의 기준에 따라 비교할 수 있는 타입이어야 함
        - 엉뚱한 타입의 원소를 추가하면 트리를 변경하기 전에 해당 원소가 들어갈 위치를 찾는 과정에서 ClassCastException을 발생
        - ⇒ 트리 내부 구조(= 객체의 상태)가 변경되기 전에 **비교가 먼저 발생**(실패 가능성 있는 작업)
3. 객체의 임시 복사본에서 작업 수행 후 성공 시에 원래 객체와 교체
    - 데이터를 임시 자료구조에 저장해 작업하는 게 더 빠를 때 적용하기 좋음
    - ex) 정렬 → 정렬 수행 전 입력 리스트의 원소들을 배열로 옮김
        - 배열 사용 시 정렬 알고리즘의 반복문에서 원소들에 훨씬 빠르게 접근 가능
        - 성능도 높이지만 정렬에 실패하더라도 입력 리스트는 변하지 않음
4. *작업 도중 발생하는 실패를 가로채는 복구 코드 작성 → 작업 전 상태로 되돌리는 방법
    - 디스크 기반의 내구성을 보장해야 하는 자료구조에 쓰임

### 실패 원자성은…

- 일반적으로 권장되지만 항상 달성할 수는 없음
    - ex) 두 스레드가 동기화 없이 같은 객체를 동시에 수정하면 해당 객체의 일관성이 깨짐
    - ConcurrentModificationException을 잡아냈다고 그 객체가 여전히 쓸 수 있는 상태라고 가정 불가
- 실패 원자적으로 만들 수 있더라도 항상 그렇게 해야 하는 것은 아님
    - 실패 원자성을 달성하기 위한 비용이나 복잡도가 아주 클 경우
- 문제가 무엇인지 알면 실패 원자성을 얻을 수 있는 경우가 많음

---

## 부록

### 작업 도중 발생하는 실패를 가로채는 복구 코드 작성 예시

- 트랜잭션: INSERT, UPDATE, DELETE 도중 문제 발생 → 롤백(rollback) 으로 이전 상태로 복구
- 파일 시스템: 파일 작성 중 전원 꺼짐/충돌 발생 → 파일 시스템은 디스크에 남긴 저널을 읽음
    - 작업 완료 전이면 취소
    - 완료했으면 반영
- Key-Value 저장소 ex) RocksDB, LevelDB
    - 메모리 + 디스크를 함께 사용
    - 데이터를 디스크에 저장할 때 쓰기 작업 로그를 먼저 기록하고 문제 발생 시 로그 읽어 복구
- 메시지 큐 시스템 ex) Kafka
    - 메시지를 디스크에 저장 후 소비자에게 전달
    - 서버가 죽어도 디스크 로그 기반으로 다시 읽기 가능
    - 메시지가 정확히 한 번만 처리되게 지원
